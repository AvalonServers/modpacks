name: Deploy
on:
  release:
    types: [created]
  workflow_dispatch: {}

jobs:
  build:
    name: Build release artifacts
    runs-on: ubuntu-20.04
    steps:
      - name: Fetch repository
        uses: actions/checkout@v2
        with:
          lfs: true
      - name: Set up Go runtime
        uses: actions/setup-go@v2
        with:
          go-version: ^1.16.13
      - name: Set up Python runtime
        uses: actions/setup-python@v3
      - name: Install Python dependencies
        run: pip install -r requirements.txt
      - name: Install Packwiz
        run: go install github.com/packwiz/packwiz@latest
      - name: Build pack zip files
        run: ./scripts/ci-build-all.sh
      - name: Upload packs artifact
        uses: actions/upload-artifact@v2
        with:
          name: packs
          path: build
      - name: Upload data artifact
        uses: actions/upload-artifact@v2
        with:
          name: data
          path: packs
  # deploy-web:
  #   name: Deploy web server
  #   needs: ["build"]
  #   runs-on: ubuntu-20.04
  #   environment: prod
  #   steps:
  #     - name: Download client package
  #       uses: actions/download-artifact@v2
  #       with:
  #         name: client
  #         path: artifacts/client
  #     - name: Download launcher package
  #       uses: actions/download-artifact@v2
  #       with:
  #         name: launcher
  #         path: artifacts/launcher
  #     - name: Copy client files to server
  #       uses: appleboy/scp-action@v0.1.1
  #       with:
  #         host: cdn.avalon.arctarus.co.uk
  #         key: ${{ secrets.AVALON_SERVER_SSH }}
  #         username: avalon-deploy
  #         source: artifacts/client
  #         target: /var/lib/avalon/cdn/ascent/client
  #         strip_components: 2
  #     - name: Copy launcher files to server
  #       uses: appleboy/scp-action@v0.1.1
  #       with:
  #         host: cdn.avalon.arctarus.co.uk
  #         key: ${{ secrets.AVALON_SERVER_SSH }}
  #         username: avalon-deploy
  #         source: artifacts/launcher
  #         target: /var/lib/avalon/cdn/ascent/launcher
  #         strip_components: 2
  # deploy-mc:
  #   name: Deploy Minecraft server
  #   needs: ["build"]
  #   runs-on: ubuntu-20.04
  #   environment: prod
  #   steps:
  #     - name: Download server package
  #       uses: actions/download-artifact@v2
  #       with:
  #         name: server
  #         path: artifacts/server
  #     - name: Copy files to server
  #       uses: appleboy/scp-action@v0.1.1
  #       with:
  #         host: srv1.avalon.arctarus.co.uk
  #         key: ${{ secrets.AVALON_SERVER_SSH }}
  #         username: avalon-deploy
  #         source: artifacts/server
  #         target: /var/lib/avalon/mc/ascent/installer
  #         strip_components: 2
  #         rm: true
  #     - name: Extract files on server and restart
  #       uses: appleboy/ssh-action@v0.1.4
  #       with:
  #         host: srv1.avalon.arctarus.co.uk
  #         key: ${{ secrets.AVALON_SERVER_SSH }}
  #         username: avalon-deploy
  #         script: |
  #           BASE_PATH=/var/lib/avalon/mc/ascent
  #           doas systemctl stop avalon-mc-ascent
  #           java -Xmx4G -jar $BASE_PATH/installer/server-installer.jar $BASE_PATH
  #           ln -sf $BASE_PATH/forge-1.12.2-14.23.5.2854.jar server.jar
  #           doas systemctl start avalon-mc-ascent
